# é¢œæ–™å–·æ´’ä¼˜åŒ–æŒ‡å—

## é—®é¢˜æè¿°

åœ¨æ¸¸æˆä¸­ï¼Œè½¦è¾†ä¼šæŒç»­å–·æ´’é¢œæ–™ï¼Œå¦‚æœä¸åŠ é™åˆ¶ï¼Œä¼šå¯¼è‡´ï¼š
- åœºæ™¯ä¸­é¢œæ–™èŠ‚ç‚¹è¿‡å¤š
- æ¸¸æˆè¿è¡Œç¼“æ…¢
- å†…å­˜å ç”¨è¿‡é«˜
- æ¸²æŸ“æ€§èƒ½ä¸‹é™

## è§£å†³æ–¹æ¡ˆ

### ä¼˜åŒ–é€»è¾‘

åœ¨`PaintManager.addPaint()`æ–¹æ³•ä¸­æ·»åŠ äº†æ™ºèƒ½åˆ¤æ–­ï¼š

1. **æ£€æŸ¥é™„è¿‘æ˜¯å¦æœ‰è‡ªå·±çš„é¢œæ–™**
2. **å¦‚æœè·ç¦»å°äºCoverage Radiusï¼Œåˆ™è·³è¿‡å–·æ´’**
3. **åªå¯¹å…¶ä»–ç©å®¶çš„é¢œæ–™è¿›è¡Œè¦†ç›–**

### æ ¸å¿ƒä»£ç 

```typescript
// åœ¨addPaintæ–¹æ³•ä¸­æ·»åŠ çš„æ£€æŸ¥
if (this.isNearOwnPaint(position2D, ownerId)) {
    // è·³è¿‡é¢œæ–™å–·æ´’ï¼Œé¿å…é‡å¤
    return;
}

// æ–°å¢çš„æ£€æŸ¥æ–¹æ³•
private isNearOwnPaint(position: Vec2, ownerId: string): boolean {
    for (const paintData of this.paintMap.values()) {
        // åªæ£€æŸ¥åŒä¸€æ‹¥æœ‰è€…çš„é¢œæ–™
        if (paintData.ownerId === ownerId) {
            const distance = Vec2.distance(paintData.position, position);
            
            // å¦‚æœè·ç¦»å°äºè¦†ç›–åŠå¾„ï¼Œè¯´æ˜é™„è¿‘å·²æœ‰è‡ªå·±çš„é¢œæ–™
            if (distance < this.coverageRadius) {
                return true;
            }
        }
    }
    return false;
}
```

## å·¥ä½œåŸç†

### ä¼˜åŒ–å‰çš„è¡Œä¸ºï¼š
```
è½¦è¾†ç§»åŠ¨ â†’ æ¯å¸§å–·æ´’é¢œæ–™ â†’ å¤§é‡é‡å¤çš„é¢œæ–™èŠ‚ç‚¹
```

### ä¼˜åŒ–åçš„è¡Œä¸ºï¼š
```
è½¦è¾†ç§»åŠ¨ â†’ æ£€æŸ¥é™„è¿‘æ˜¯å¦æœ‰è‡ªå·±çš„é¢œæ–™ â†’ 
â”œâ”€ æœ‰ï¼šè·³è¿‡å–·æ´’
â””â”€ æ— ï¼šæ­£å¸¸å–·æ´’
```

## å‚æ•°è¯´æ˜

### Coverage Radius
- **ä½ç½®**: PaintManagerç»„ä»¶çš„å±æ€§
- **é»˜è®¤å€¼**: 30åƒç´ 
- **ä½œç”¨**: æ§åˆ¶é¢œæ–™è¦†ç›–å’Œé‡å¤æ£€æµ‹çš„èŒƒå›´
- **è°ƒæ•´å»ºè®®**: 
  - å¢å¤§ â†’ é¢œæ–™æ›´ç¨€ç–ï¼Œæ€§èƒ½æ›´å¥½
  - å‡å° â†’ é¢œæ–™æ›´å¯†é›†ï¼Œè§†è§‰æ•ˆæœæ›´å¥½

## æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### èŠ‚ç‚¹æ•°é‡å‡å°‘
- **ä¼˜åŒ–å‰**: è½¦è¾†æ¯å¸§éƒ½å¯èƒ½åˆ›å»ºé¢œæ–™èŠ‚ç‚¹
- **ä¼˜åŒ–å**: åªåœ¨å¿…è¦æ—¶åˆ›å»ºé¢œæ–™èŠ‚ç‚¹
- **é¢„æœŸå‡å°‘**: 60-80%çš„é¢œæ–™èŠ‚ç‚¹

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- å‡å°‘Nodeå¯¹è±¡åˆ›å»º
- å‡å°‘Mapå­˜å‚¨çš„æ•°æ®é‡
- é™ä½åƒåœ¾å›æ”¶å‹åŠ›

### æ¸²æŸ“æ€§èƒ½æå‡
- å‡å°‘DrawCallæ•°é‡
- é™ä½GPUæ¸²æŸ“è´Ÿæ‹…
- æé«˜å¸§ç‡ç¨³å®šæ€§

## æ¸¸æˆé€»è¾‘ä¿æŒ

### ä¿ç•™çš„åŠŸèƒ½ï¼š
1. âœ… **é¢œæ–™è¦†ç›–**: ä¸åŒç©å®¶çš„é¢œæ–™ä»ç„¶å¯ä»¥ç›¸äº’è¦†ç›–
2. âœ… **é¢†åœŸäº‰å¤º**: æ¸¸æˆçš„æ ¸å¿ƒç©æ³•ä¸å—å½±å“
3. âœ… **è§†è§‰æ•ˆæœ**: é¢œæ–™åˆ†å¸ƒä»ç„¶è‡ªç„¶

### ä¼˜åŒ–çš„éƒ¨åˆ†ï¼š
1. ğŸš€ **é¿å…é‡å¤**: åŒä¸€è½¦è¾†ä¸ä¼šåœ¨é™„è¿‘é‡å¤å–·æ´’
2. ğŸš€ **æ€§èƒ½æå‡**: å‡å°‘ä¸å¿…è¦çš„èŠ‚ç‚¹åˆ›å»º
3. ğŸš€ **å†…å­˜ä¼˜åŒ–**: é™ä½å†…å­˜å ç”¨

## è°ƒè¯•å’Œç›‘æ§

### æ§åˆ¶å°æ—¥å¿—
- æˆåŠŸå–·æ´’: `æ·»åŠ é¢œæ–™: æ‹¥æœ‰è€…=car-1, ä½ç½®=(100.0, 200.0)`
- è·³è¿‡å–·æ´’: å¯ä»¥å–æ¶ˆæ³¨é‡Šæ—¥å¿—æ¥æŸ¥çœ‹è·³è¿‡æƒ…å†µ

### æ€§èƒ½ç›‘æ§
```typescript
// å¯ä»¥æ·»åŠ ç»Ÿè®¡ä»£ç 
private paintSkipCount: number = 0;
private paintCreateCount: number = 0;

// åœ¨isNearOwnPaintè¿”å›trueæ—¶
this.paintSkipCount++;

// åœ¨æˆåŠŸåˆ›å»ºé¢œæ–™æ—¶
this.paintCreateCount++;

// å®šæœŸè¾“å‡ºç»Ÿè®¡
console.log(`é¢œæ–™ç»Ÿè®¡: åˆ›å»º=${this.paintCreateCount}, è·³è¿‡=${this.paintSkipCount}`);
```

## è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. æ—¶é—´é—´éš”é™åˆ¶
```typescript
// ä¸ºæ¯ä¸ªè½¦è¾†æ·»åŠ å–·æ´’å†·å´æ—¶é—´
private lastPaintTime: Map<string, number> = new Map();

public addPaint(paintPrefab: Prefab, worldPosition: Vec3, ownerId: string): void {
    const now = Date.now();
    const lastTime = this.lastPaintTime.get(ownerId) || 0;
    
    // é™åˆ¶å–·æ´’é¢‘ç‡ï¼ˆä¾‹å¦‚æ¯100msä¸€æ¬¡ï¼‰
    if (now - lastTime < 100) {
        return;
    }
    
    this.lastPaintTime.set(ownerId, now);
    // ... å…¶ä»–é€»è¾‘
}
```

### 2. åŒºåŸŸåˆ†å—ç®¡ç†
```typescript
// å°†åœ°å›¾åˆ†æˆç½‘æ ¼ï¼Œåªæ£€æŸ¥ç›¸é‚»ç½‘æ ¼çš„é¢œæ–™
private paintGrid: Map<string, PaintData[]> = new Map();
```

### 3. é¢œæ–™ç”Ÿå‘½å‘¨æœŸ
```typescript
// ä¸ºé¢œæ–™æ·»åŠ ç”Ÿå‘½å‘¨æœŸï¼Œè‡ªåŠ¨æ¸…ç†æ—§é¢œæ–™
private cleanupOldPaint(): void {
    const now = Date.now();
    const maxAge = 60000; // 60ç§’
    
    this.paintMap.forEach((paintData, paintId) => {
        if (now - paintData.timestamp > maxAge) {
            this.removePaint(paintId);
        }
    });
}
```

## æ€»ç»“

è¿™ä¸ªä¼˜åŒ–é€šè¿‡ç®€å•çš„è·ç¦»æ£€æŸ¥ï¼Œæœ‰æ•ˆå‡å°‘äº†é‡å¤é¢œæ–™çš„åˆ›å»ºï¼Œåœ¨ä¿æŒæ¸¸æˆç©æ³•ä¸å˜çš„å‰æä¸‹æ˜¾è‘—æå‡äº†æ€§èƒ½ã€‚ä½ å¯ä»¥é€šè¿‡è°ƒæ•´`coverageRadius`å‚æ•°æ¥å¹³è¡¡æ€§èƒ½å’Œè§†è§‰æ•ˆæœã€‚
