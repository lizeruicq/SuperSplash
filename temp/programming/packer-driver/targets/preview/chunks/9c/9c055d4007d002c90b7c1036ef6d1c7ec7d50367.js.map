{"version":3,"sources":["file:///Users/zeruili/projects/cocos_project/driftClash/assets/scripts/PaintManager.ts"],"names":["_decorator","Component","Node","instantiate","Vec2","Layers","ccclass","property","PaintManager","paintMap","Map","paintContainer","getInstance","_instance","onLoad","console","log","node","destroy","layer","Enum","UI_2D","addChild","onDestroy","addPaint","paintPrefab","worldPosition","ownerId","warn","position2D","x","y","isNearOwnPaint","checkAndRemoveOverlappingPaint","paintNode","setWorldPosition","paintId","generatePaintId","paintData","position","timestamp","Date","now","set","newPosition","newOwnerId","toRemove","forEach","distance","coverageRadius","push","removePaint","length","get","isValid","delete","values","toFixed","clearAllPaint","clear","getPaintCountByOwner","count","getTotalPaintCount","size","getPaintRatioByOwner","totalCount","ownerCount","getAllPaintRatios","ratios","ownerCounts","getSortedPaintRatios","result","ratio","sort","a","b"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Prefab, instantiate, Vec2, Vec3, Layers } from 'cc';\nconst { ccclass, property } = _decorator;\n\n/**\n * 颜料数据接口\n */\ninterface PaintData {\n    node: Node;           // 颜料节点\n    position: Vec2;       // 位置\n    ownerId: string;      // 拥有者ID（车辆ID）\n    timestamp: number;    // 创建时间戳\n}\n\n/**\n * 颜料管理器\n * 负责管理游戏中所有车辆喷洒的颜料\n */\n@ccclass('PaintManager')\nexport class PaintManager extends Component {\n    private static _instance: PaintManager = null!;\n    \n    // 存储所有颜料的数据\n    private paintMap: Map<string, PaintData> = new Map();\n    \n    // 颜料覆盖检测的距离阈值（像素）\n    @property\n    coverageRadius: number = 30;\n    \n    // 颜料容器节点\n    private paintContainer: Node = null!;\n\n    public static getInstance(): PaintManager {\n        return PaintManager._instance;\n    }\n\n    onLoad() {\n        if (PaintManager._instance) {\n            console.log(\"销毁原有PaintManager单例\");\n            this.node.destroy();\n            return;\n        }\n        PaintManager._instance = this;\n        \n        // 创建颜料容器节点\n        this.paintContainer = new Node('PaintContainer');\n\n        // 设置容器节点的层级为UI_2D，确保颜料固定在游戏世界坐标中\n        this.paintContainer.layer = Layers.Enum.UI_2D;\n\n        this.node.addChild(this.paintContainer);\n        \n        console.log('PaintManager初始化完成');\n    }\n\n    onDestroy() {\n        if (PaintManager._instance === this) {\n            PaintManager._instance = null!;\n            console.log(\"PaintManager实例已销毁\");\n        }\n    }\n\n    /**\n     * 添加颜料\n     * @param paintPrefab 颜料预制体\n     * @param worldPosition 世界坐标位置\n     * @param ownerId 拥有者ID\n     */\n    public addPaint(paintPrefab: Prefab, worldPosition: Vec3, ownerId: string): void {\n        if (!paintPrefab || !this.paintContainer) {\n            console.warn('PaintManager: 颜料预制体或容器为空');\n            return;\n        }\n\n        const position2D = new Vec2(worldPosition.x, worldPosition.y);\n\n        // 检查是否在同一拥有者的颜料附近，如果是则不喷洒\n        if (this.isNearOwnPaint(position2D, ownerId)) {\n            // console.log(`跳过颜料喷洒: 拥有者=${ownerId}, 位置附近已有自己的颜料`);\n            return;\n        }\n\n        // 检查是否需要覆盖其他拥有者的颜料\n        this.checkAndRemoveOverlappingPaint(position2D, ownerId);\n\n        // 创建新颜料节点\n        const paintNode = instantiate(paintPrefab);\n        paintNode.setWorldPosition(worldPosition);\n\n        // 设置颜料节点的层级为UI_2D，确保它固定在游戏世界坐标中\n        paintNode.layer = Layers.Enum.UI_2D;\n\n        this.paintContainer.addChild(paintNode);\n\n        // 生成唯一ID\n        const paintId = this.generatePaintId(position2D, ownerId);\n\n        // 存储颜料数据\n        const paintData: PaintData = {\n            node: paintNode,\n            position: position2D,\n            ownerId: ownerId,\n            timestamp: Date.now()\n        };\n\n        this.paintMap.set(paintId, paintData);\n\n        // console.log(`添加颜料: 拥有者=${ownerId}, 位置=(${position2D.x.toFixed(1)}, ${position2D.y.toFixed(1)})`);\n    }\n\n    /**\n     * 检查并移除重叠的颜料\n     * @param newPosition 新颜料位置\n     * @param newOwnerId 新颜料拥有者ID\n     */\n    private checkAndRemoveOverlappingPaint(newPosition: Vec2, newOwnerId: string): void {\n        const toRemove: string[] = [];\n        \n        this.paintMap.forEach((paintData, paintId) => {\n            const distance = Vec2.distance(paintData.position, newPosition);\n            \n            // 如果距离小于覆盖半径，且不是同一个拥有者，则移除旧颜料\n            if (distance < this.coverageRadius && paintData.ownerId !== newOwnerId) {\n                toRemove.push(paintId);\n                \n            }\n        });\n        \n        // 移除重叠的颜料\n        toRemove.forEach(paintId => {\n            this.removePaint(paintId);\n        });\n        \n        if (toRemove.length > 0) {\n            // console.log(`移除了 ${toRemove.length} 个重叠的颜料`);\n        }\n    }\n\n    /**\n     * 移除指定的颜料\n     * @param paintId 颜料ID\n     */\n    private removePaint(paintId: string): void {\n        const paintData = this.paintMap.get(paintId);\n        if (paintData) {\n            // 销毁节点\n            if (paintData.node && paintData.node.isValid) {\n                paintData.node.destroy();\n            }\n            \n            // 从映射中移除\n            this.paintMap.delete(paintId);\n        }\n    }\n\n    /**\n     * 检查指定位置是否在同一拥有者的颜料附近\n     * @param position 要检查的位置\n     * @param ownerId 拥有者ID\n     * @returns 如果附近有同一拥有者的颜料则返回true\n     */\n    private isNearOwnPaint(position: Vec2, ownerId: string): boolean {\n        for (const paintData of this.paintMap.values()) {\n            // 只检查同一拥有者的颜料\n            if (paintData.ownerId === ownerId) {\n                const distance = Vec2.distance(paintData.position, position);\n\n                // 如果距离小于覆盖半径，说明附近已有自己的颜料\n                if (distance < this.coverageRadius) {\n                    return true;\n                }\n            }\n        }\n        return false;\n    }\n\n    /**\n     * 生成颜料唯一ID\n     * @param position 位置\n     * @param ownerId 拥有者ID\n     * @returns 唯一ID\n     */\n    private generatePaintId(position: Vec2, ownerId: string): string {\n        const timestamp = Date.now();\n        return `paint_${ownerId}_${position.x.toFixed(0)}_${position.y.toFixed(0)}_${timestamp}`;\n    }\n\n    /**\n     * 清除所有颜料\n     */\n    public clearAllPaint(): void {\n        this.paintMap.forEach((paintData) => {\n            if (paintData.node && paintData.node.isValid) {\n                paintData.node.destroy();\n            }\n        });\n        \n        this.paintMap.clear();\n        console.log('清除了所有颜料');\n    }\n\n    /**\n     * 获取指定拥有者的颜料数量\n     * @param ownerId 拥有者ID\n     * @returns 颜料数量\n     */\n    public getPaintCountByOwner(ownerId: string): number {\n        let count = 0;\n        this.paintMap.forEach((paintData) => {\n            if (paintData.ownerId === ownerId) {\n                count++;\n            }\n        });\n        return count;\n    }\n\n    /**\n     * 获取总颜料数量\n     * @returns 总数量\n     */\n    public getTotalPaintCount(): number {\n        return this.paintMap.size;\n    }\n\n    /**\n     * 获取指定拥有者的颜料占比\n     * @param ownerId 拥有者ID\n     * @returns 占比（0-1之间的小数）\n     */\n    public getPaintRatioByOwner(ownerId: string): number {\n        const totalCount = this.getTotalPaintCount();\n        if (totalCount === 0) {\n            return 0;\n        }\n\n        const ownerCount = this.getPaintCountByOwner(ownerId);\n        return ownerCount / totalCount;\n    }\n\n    /**\n     * 获取所有车辆的颜料占比\n     * @returns 包含每个车辆ID和其占比的对象\n     */\n    public getAllPaintRatios(): { [ownerId: string]: number } {\n        const ratios: { [ownerId: string]: number } = {};\n        const totalCount = this.getTotalPaintCount();\n\n        if (totalCount === 0) {\n            return ratios;\n        }\n\n        // 统计每个拥有者的颜料数量\n        const ownerCounts: { [ownerId: string]: number } = {};\n        this.paintMap.forEach((paintData) => {\n            const ownerId = paintData.ownerId;\n            ownerCounts[ownerId] = (ownerCounts[ownerId] || 0) + 1;\n        });\n\n        // 计算占比\n        for (const ownerId in ownerCounts) {\n            ratios[ownerId] = ownerCounts[ownerId] / totalCount;\n        }\n\n        return ratios;\n    }\n\n    /**\n     * 获取排序后的颜料占比（从高到低）\n     * @returns 按占比排序的数组，每个元素包含ownerId和ratio\n     */\n    public getSortedPaintRatios(): Array<{ ownerId: string, ratio: number, count: number }> {\n        const ratios = this.getAllPaintRatios();\n        const result: Array<{ ownerId: string, ratio: number, count: number }> = [];\n\n        for (const ownerId in ratios) {\n            result.push({\n                ownerId: ownerId,\n                ratio: ratios[ownerId],\n                count: this.getPaintCountByOwner(ownerId)\n            });\n        }\n\n        // 按占比从高到低排序\n        result.sort((a, b) => b.ratio - a.ratio);\n\n        return result;\n    }\n}\n"]}